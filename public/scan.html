<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Shelf-Life – Scan</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.4;margin:24px}
      .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:16px}
      .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid #d1d5db;background:#f3f4f6;cursor:pointer}
      .btn.primary{background:#111827;color:#fff;border-color:#111827}
      .muted{color:#6b7280}
      #preview{max-width:100%;border:1px dashed #d1d5db;border-radius:10px;margin-top:8px}
      #result pre{white-space:pre-wrap;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
      .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;margin-right:6px}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  </head>
  <body>
    <h1>Scan label / Skener etikete</h1>

    <div class="card">
      <div class="row">
        <label class="btn">
          📷 Choose image (JPG/PNG/HEIC)
          <input id="file" type="file" accept="image/*,.heic" hidden />
        </label>
        <button id="run" class="btn primary">Run OCR</button>
        <label class="row muted">
          <input type="checkbox" id="show-pre" checked /> preview pre-processed
        </label>
      </div>
      <img id="preview" alt="preview" />
      <canvas id="work" hidden></canvas>
    </div>

    <div class="card">
      <div id="result"><div class="muted">No result yet.</div></div>
    </div>

    <script>
      const fileEl = document.getElementById('file');
      const runBtn = document.getElementById('run');
      const preview = document.getElementById('preview');
      const work = document.getElementById('work');
      const showPre = document.getElementById('show-pre');
      const result = document.getElementById('result');

      let lastFile = null;

      fileEl.addEventListener('change', () => {
        lastFile = fileEl.files[0] || null;
        if (lastFile) preview.src = URL.createObjectURL(lastFile);
      });

      runBtn.addEventListener('click', async () => {
        if (!lastFile) { alert('Choose an image first.'); return; }
        try {
          setStatus('Pre-processing…');
          const pre = await preprocess(lastFile);
          if (showPre.checked) preview.src = URL.createObjectURL(pre);

          const form = new FormData();
          form.append('image', pre, 'preprocessed.png');

          setStatus('Calling /api/ocr-date2…');
          let r = await fetch('/api/ocr-date2', { method: 'POST', body: form });
          if (r.status === 503) {
            setStatus('Light deploy – falling back to /api/ocr-date…');
            r = await fetch('/api/ocr-date', { method: 'POST', body: form });
          }
          const data = await r.json();
          renderResult(data, r.status);
        } catch (e) {
          console.error(e);
          setStatus('❌ ' + (e && e.message ? e.message : 'Unexpected error'));
        }
      });

      function setStatus(msg) { result.innerHTML = `<div class="muted">${escapeHtml(msg)}</div>`; }
      function tag(txt){ return `<span class="tag">${escapeHtml(txt)}</span>`; }
      function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m])); }

      function renderResult(data, status) {
        const tags = [];
        if (data && typeof data.score === 'number') tags.push(tag(`score ${data.score.toFixed(2)}`));
        if (data && data.pattern) tags.push(tag(data.pattern));
        if (status === 503) tags.push(tag('503 fallback'));
        result.innerHTML = `
          <div style="margin-bottom:8px">${tags.join(' ')}</div>
          <div><strong>Detected date:</strong> ${escapeHtml(data && data.date ? data.date : '—')}</div>
          <div><strong>Raw candidates:</strong> ${escapeHtml((data && data.raw && data.raw.join(', ')) || '—')}</div>
          <details style="margin-top:10px"><summary>OCR text</summary>
            <pre>${escapeHtml((data && data.text) || '')}</pre>
          </details>
        `;
      }

      async function preprocess(file) {
        let blob = file;
        if ((file.type && file.type.toLowerCase().includes('heic')) || file.name.toLowerCase().endsWith('.heic')) {
          try { blob = await window.heic2any({ blob: file, toType: 'image/jpeg', quality: 0.9 }); }
          catch (e) { console.warn('HEIC convert failed, sending original', e); }
        }
        const bmp = await createImageBitmap(blob);
        const maxSide = 2000;
        const scale = Math.min(1, maxSide / Math.max(bmp.width, bmp.height));
        work.width = Math.round(bmp.width * scale);
        work.height = Math.round(bmp.height * scale);
        const ctx = work.getContext('2d');
        ctx.drawImage(bmp, 0, 0, work.width, work.height);

        // Grayscale
        let imgData = ctx.getImageData(0, 0, work.width, work.height);
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
          const g = Math.round(0.2126 * d[i] + 0.7152 * d[i + 1] + 0.0722 * d[i + 2]);
          d[i] = d[i + 1] = d[i + 2] = g;
        }
        // Otsu threshold
        const hist = new Uint32Array(256);
        for (let i = 0; i < d.length; i += 4) hist[d[i]]++;
        const total = work.width * work.height;
        let sum = 0; for (let t = 0; t < 256; t++) sum += t * hist[t];
        let sumB = 0, wB = 0, varMax = -1, thr = 127;
        for (let t = 0; t < 256; t++) {
          wB += hist[t]; if (!wB) continue; const wF = total - wB; if (!wF) break;
          sumB += t * hist[t];
          const mB = sumB / wB, mF = (sum - sumB) / wF;
          const v = wB * wF * (mB - mF) * (mB - mF);
          if (v > varMax) { varMax = v; thr = t; }
        }
        for (let i = 0; i < d.length; i += 4) {
          const v = d[i] > thr ? 255 : 0;
          d[i] = d[i + 1] = d[i + 2] = v;
        }
        ctx.putImageData(imgData, 0, 0);
        const out = await new Promise(res => work.toBlob(res, "image/png", 0.95));
        return out;
      }
    </script>
  </body>
</html>
