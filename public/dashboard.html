<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Shelf-Life – Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .topbar { background:#111; color:#fff; padding:8px 12px; border-radius:10px; margin-bottom:12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;}
    .btn { padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
    .btn.refresh{ background:#2563eb; color:#fff; }
    .legend { display:flex; gap:8px; align-items:center; font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .g{ background:#e8f5e9; color:#1b5e20;}     /* green */
    .y{ background:#fff8e1; color:#8a6d00;}     /* yellow */
    .o{ background:#fff3e0; color:#e65100;}     /* orange */
    .r{ background:#ffebee; color:#b71c1c;}     /* red */
    .u{ background:#eceff1; color:#37474f;}     /* unknown/gray */
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:8px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="modeLabel">✅ Dashboard (PCT način)</div>
    <div class="legend">
      <span class="pill g" id="lg">>60% / >90d</span>
      <span class="pill y" id="ly">30–60% / 31–90d</span>
      <span class="pill o" id="lo">10–30% / 11–30d</span>
      <span class="pill r" id="lr">≤10% / ≤10d</span>
      <span class="pill u">?</span>
    </div>
    <button id="btnRefresh" class="btn refresh">🔄 Osvježi</button>
    <button id="btnToggle" class="btn">🔀 Prebaci način</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:210px;">Time</th>
        <th>Product</th>
        <th>Shelf life</th>
        <th>Status</th>
        <th>Metadata</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="5">Učitavam…</td></tr></tbody>
  </table>

<script>
function getParam(name, def){ const u=new URL(window.location.href); return u.searchParams.get(name)||def; }
function setParam(name, value){
  const u=new URL(window.location.href); u.searchParams.set(name, value);
  window.history.replaceState(null, "", u.toString());
}

function addDays(iso, days){ try{ const d=new Date(iso); if(!isFinite(d)) return null; d.setUTCDate(d.getUTCDate()+Number(days||0)); return d; }catch{ return null; } }
function daysBetween(a,b){ return Math.ceil((b-a)/86400000); }

function bucketAbs(d){
  if(d==null) return "u";
  if(d<=10) return "r";
  if(d<=30) return "o";
  if(d<=90) return "y";
  return "g";
}
function bucketAbsLabel(d){
  if(d==null) return "?";
  if(d<=10) return "≤10 d";
  if(d<=30) return "11–30 d";
  if(d<=90) return "31–90 d";
  return ">90 d";
}

function bucketPct(pct){
  if(pct==null) return "u";
  if(pct<=10) return "r";
  if(pct<=30) return "o";
  if(pct<=60) return "y";
  return "g";
}
function bucketPctLabel(pct){
  if(pct==null) return "?";
  if(pct<=10) return "≤10%";
  if(pct<=30) return "10–30%";
  if(pct<=60) return "30–60%";
  return ">60%";
}

async function fetchValid(limit=100){
  const res = await fetch(`/logs/valid?limit=${limit}`);
  const j = await res.json();
  return j.items || [];
}

function renderRows(items, mode){
  const tb = document.getElementById("tbody");
  if(!items.length){ tb.innerHTML = '<tr><td colspan="5">Nema zapisa.</td></tr>'; return; }

  const now = new Date();
  const rows = items.map(x=>{
    const d = x.data || {};
    const sl = d.shelf_life || {};
    const md = d.metadata || {};
    const lu = md.last_updated || null;

    let days_left = null, pct_left = null, badgeClass="u", badgeText="?";

    // izračunaj dane do isteka ako imamo last_updated i unopened_days
    if(lu!=null && Number.isFinite(+sl.unopened_days)){
      const expiry = addDays(lu, sl.unopened_days||0);
      if(expiry){
        days_left = Math.max(0, daysBetween(now, expiry)); // bez negativnih
      }
    }

    if(Number.isFinite(+sl.unopened_days) && sl.unopened_days>0 && days_left!=null){
      pct_left = Math.max(0, Math.round(100 * (days_left / sl.unopened_days)));
    }

    if(mode==="abs"){
      badgeClass = bucketAbs(days_left);
      badgeText = (days_left==null ? "?" : `${days_left} d`) + " • " + bucketAbsLabel(days_left);
    }else{
      // default: postotak (ako nemamo pct, fallback na apsolutne dane)
      if(pct_left==null && days_left!=null && sl.unopened_days>0){
        pct_left = Math.max(0, Math.round(100 * (days_left / sl.unopened_days)));
      }
      badgeClass = bucketPct(pct_left);
      badgeText = (pct_left==null ? "?" : `${pct_left}%`) + " • " + bucketPctLabel(pct_left);
    }

    return { x, days_left, pct_left, badgeClass, badgeText };
  });

  // sortiraj (crveni na vrh): prvo po badge “težini”, pa po malo dana/pct, pa po vremenu
  const weight = { r:0, o:1, y:2, g:3, u:4 };
  rows.sort((a,b)=>{
    if(weight[a.badgeClass]!==weight[b.badgeClass]) return weight[a.badgeClass]-weight[b.badgeClass];
    // unutar istog bucket-a: manje dana/pct prvo
    const av = (a.pct_left!=null ? a.pct_left : a.days_left);
    const bv = (b.pct_left!=null ? b.pct_left : b.days_left);
    if(av!=null && bv!=null && av!==bv) return av - bv;
    return (new Date(b.x.received_at) - new Date(a.x.received_at));
  });

  tb.innerHTML = "";
  for(const r of rows){
    const d = r.x.data || {};
    const p = d.product || {};
    const sl = d.shelf_life || {};
    const st = d.status || {};
    const md = d.metadata || {};
    const pill = `<span class="pill ${r.badgeClass}">${r.badgeText}</span>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.x.received_at}</td>
      <td>
        <div><strong>${p.name||"-"}</strong></div>
        <div>Barcode: <span class="mono">${p.barcode||"-"}</span></div>
        <div class="mono">${p.category||"-"}</div>
      </td>
      <td>
        <div>unopened: ${sl.unopened_days??"-"} d</div>
        <div>opened: ${sl.opened_days??"-"} d</div>
        <div>temp: ${sl.storage_temp||"-"}</div>
        <div>${pill}</div>
      </td>
      <td>
        <div>confidence: ${st.confidence??"-"}</div>
        <div>safe: ${String(st.safe_to_consume)}</div>
        <div>codes: ${(st.reason_codes||[]).join(", ")}</div>
      </td>
      <td>
        <div>updated: ${md.last_updated||"-"}</div>
        <div>source: ${md.source||"-"}</div>
      </td>
    `;
    document.getElementById("tbody").appendChild(tr);
  }
}

function applyLegend(mode){
  const isAbs = (mode==="abs");
  document.getElementById("modeLabel").textContent = isAbs ? "✅ Dashboard (ABS način)" : "✅ Dashboard (PCT način)";
  document.getElementById("lg").textContent = isAbs ? ">90d"    : ">60%";
  document.getElementById("ly").textContent = isAbs ? "31–90d"  : "30–60%";
  document.getElementById("lo").textContent = isAbs ? "11–30d"  : "10–30%";
  document.getElementById("lr").textContent = isAbs ? "≤10d"    : "≤10%";
}

async function load(){
  const mode = (getParam("mode","pct").toLowerCase()==="abs"?"abs":"pct");
  applyLegend(mode);
  const items = await fetchValid(100);
  renderRows(items, mode);
}

document.getElementById("btnRefresh").addEventListener("click", load);
document.getElementById("btnToggle").addEventListener("click", ()=>{
  const current = getParam("mode","pct");
  const next = (current==="pct"?"abs":"pct");
  setParam("mode", next);
  load();
});

load();
</script>
</body>
</html>
