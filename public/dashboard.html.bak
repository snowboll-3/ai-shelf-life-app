<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Shelf-Life – Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1621; --muted:#a7b0bd; --text:#e8eef6;
      --green:#16a34a; --yellow:#eab308; --orange:#f97316; --red:#dc2626; --blue:#60a5fa;
    }
    *{box-sizing:border-box} body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{margin:0 0 10px 0; font-weight:700}
    .meta{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; color:var(--muted)}
    .chip{padding:4px 10px; background:#101826; border:1px solid #1d2736; border-radius:999px;}
    .row{display:flex; gap:8px; align-items:center}
    button, select{background:#132033; color:var(--text); border:1px solid #233247; padding:8px 12px; border-radius:10px; cursor:pointer}
    button:hover{background:#172844}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{color:var(--muted); font-weight:600; text-align:left; padding:6px 10px}
    tbody tr{background:var(--card); border:1px solid #1b2636}
    tbody td{padding:10px}
    .prod{font-weight:700}
    .muted{color:var(--muted); font-size:12px}
    .col{display:flex; flex-direction:column; gap:4px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #243248; color:var(--muted)}
    .bar{height:8px; background:#0f1a27; border:1px solid #1e2a3b; border-radius:999px; overflow:hidden}
    .bar > span{display:block; height:100%}
    .g{background:var(--green)} .y{background:var(--yellow)} .o{background:var(--orange)} .r{background:var(--red)}
    .tag{display:inline-block; padding:2px 6px; border-radius:6px; background:#132033; border:1px solid #243248; color:var(--muted); font-size:12px}
    .right{display:flex; gap:6px; align-items:center; justify-content:flex-end}
    .danger{color:var(--red)} .warn{color:var(--orange)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h1>AI Shelf-Life – Dashboard</h1>
        <div id="counters" class="meta"></div>
      </div>
      <div class="row" style="gap:8px">
        <label class="row" style="gap:6px; color:var(--muted)">
          Tip:
          <select id="typeSel">
            <option value="valid">valid</option>
            <option value="invalid">invalid</option>
          </select>
        </label>
        <label class="row" style="gap:6px; color:var(--muted)">
          Limit:
          <select id="limitSel">
            <option>10</option>
            <option selected>100</option>
            <option>200</option>
          </select>
        </label>
        <button id="refreshBtn">Osvježi</button>
      </div>
    </div>

    <div style="margin:10px 0 16px 0">
      <span class="tag">🧪 Tester</span>
      <span id="tipMsg" class="tag">Savjet: crveno ≤10 dana, narančasto ≤30, žuto ≤75 dana, zeleno >75 dana</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:190px">Time</th>
          <th style="width:260px">Product</th>
          <th style="width:210px">Shelf life</th>
          <th>Status</th>
          <th style="width:240px">Metadata</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

<script>
const fmt = (n, unit="d") => (n ?? 0) + " " + unit;
const riskBucket = (days) => {
  if (days == null) return {cls:"y", label:"n/a"};
  if (days <= 10) return {cls:"r", label:"≤10 d"};
  if (days <= 30) return {cls:"o", label:"≤30 d"};
  if (days <= 75) return {cls:"y", label:"≤75 d"};
  return {cls:"g", label:">75 d"};
};
const pctBar = (pct) => {
  let cls = "g"; // default
  if (pct <= 15) cls = "r";
  else if (pct <= 40) cls = "o";
  else if (pct <= 70) cls = "y";
  return `<div class="bar"><span class="${cls}" style="width:${Math.max(0, Math.min(100, pct))}%"></span></div>`;
};

async function load(type="valid", limit=100) {
  const res = await fetch(`/logs/${type}?limit=${limit}`);
  const json = await res.json();
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  if (type === "valid") {
    document.getElementById("counters").innerHTML =
      `<span class="chip">Total: ${json.total}</span>
       <span class="chip">Valid: ${json.total}</span>
       <span class="chip">Invalid: <a href="/logs/invalid?limit=5" style="color:var(--blue)">vidi</a></span>`;
  } else {
    document.getElementById("counters").innerHTML =
      `<span class="chip">Total invalid: ${json.total}</span>
       <span class="chip"><a href="/logs/invalid.csv" style="color:var(--blue)">Preuzmi CSV</a></span>`;
  }

  (json.items || []).forEach(it => {
    const p = it.data?.product || {};
    const sl = it.data?.shelf_life || {};
    const st = it.data?.status || {};
    const md = it.data?.metadata || {};

    // heuristika: “preostalo” = unopened_days (nemamo stvarni datum isteka u logu)
    const days = sl.unopened_days ?? 0;
    const bucket = riskBucket(days);

    // “postotak” prikaz – čisto vizualno (pretpostavi 100 dana = 100%)
    const pct = Math.max(0, Math.min(100, Math.round((days / 100) * 100)));

    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col">
        <div>${new Date(it.received_at).toISOString()}</div>
        <span class="pill ${bucket.cls}">${bucket.label}</span>
      </td>

      <td class="col">
        <div class="prod">${p.name ?? "-"}</div>
        <div class="muted">Barcode: ${p.barcode ?? "-"}</div>
        <div class="muted">${p.category ?? "-"}</div>
      </td>

      <td class="col">
        <div>unopened: <b>${fmt(sl.unopened_days)}</b></div>
        <div>opened: <b>${fmt(sl.opened_days)}</b></div>
        <div>temp: <b>${sl.storage_temp ?? "-"}</b></div>
      </td>

      <td class="col">
        <div class="row" style="gap:8px; align-items:center">
          <div><b>${pct}%</b> • ${pct >= 60 ? "&gt;60%" : (pct >= 30 ? "30–60%" : "&lt;30%")}</div>
        </div>
        ${pctBar(pct)}
        <div class="muted">confidence: ${st.confidence ?? "-"}</div>
        <div class="muted">safe: ${st.safe_to_consume ? "true" : "false"}</div>
        <div class="muted">codes: ${(st.reason_codes||[]).join(", ") || "-"}</div>
      </td>

      <td class="col">
        <div class="muted">updated: ${md.last_updated ?? "-"}</div>
        <div class="muted">source: ${md.source ?? "-"}</div>
      </td>
    `;
    tb.appendChild(row);
  });
}

document.getElementById("refreshBtn").addEventListener("click", () => {
  load(document.getElementById("typeSel").value, Number(document.getElementById("limitSel").value||100));
});
document.getElementById("typeSel").addEventListener("change", () => {
  load(document.getElementById("typeSel").value, Number(document.getElementById("limitSel").value||100));
});
document.getElementById("limitSel").addEventListener("change", () => {
  load(document.getElementById("typeSel").value, Number(document.getElementById("limitSel").value||100));
});

load("valid", 100);
</script>
</body>
</html>
