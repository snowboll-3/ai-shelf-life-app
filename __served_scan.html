﻿<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Shelf-Life – Skeniranje</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#16a34a}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border:1px solid #374151;border-radius:8px;background:#0f172a;color:#e5e7eb;cursor:pointer}
    .btn:hover{background:#0b1328}
    video{width:100%;max-height:60vh;background:#000;border-radius:12px}
    canvas{max-width:100%;border-radius:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px}
    .muted{color:var(--muted)}
    input,select{background:#0f172a;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:6px 8px}
    .ok{color:#10b981}.warn{color:#f59e0b}.bad{color:#ef4444}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
  <!-- ZXing za barkod (CDN) -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <header>
    <h1>📷 Skeniranje</h1>
    <a class="btn" href="/dashboard.hr.html">HR</a>
    <a class="btn" href="/dashboard.en.html">EN</a>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="startBtn" class="btn">▶️ Pokreni kameru</button>
        <button id="stopBtn" class="btn">⏹️ Zaustavi</button>
        <button id="snapBtn" class="btn">📸 Snimi kadar (za datum)</button>
      </div>
      <video id="preview" playsinline muted></video>
      <div class="muted small">Savjet: približi kod i osvjetli etiketu za bolji OCR.</div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0">Rezultati</h3>
      <div class="kv">
        <div class="muted">Barkod:</div><div id="barcode" class="mono">—</div>
        <div class="muted">Artikal:</div><div id="product">—</div>
        <div class="muted">Datum (OCR):</div><div id="expiry">—</div>
        <div class="muted">Confidence:</div><div id="conf">—</div>
      </div>
      <div style="margin-top:10px">
        <canvas id="shot" width="0" height="0"></canvas>
      </div>
    </section>
  </main>

<script>
const video = document.getElementById('preview');
const shot  = document.getElementById('shot');
const barcodeEl = document.getElementById('barcode');
const productEl = document.getElementById('product');
const expiryEl  = document.getElementById('expiry');
const confEl    = document.getElementById('conf');

let codeReader = null;
let stopFn = null;
let lastBarcode = null;
let lastProduct = null;

function drawSnapshot(scale=1){
  const w = video.videoWidth || 0, h = video.videoHeight || 0;
  if (!w || !h) return null;
  let targetW = Math.round(w*scale), targetH = Math.round(h*scale);
  targetW = Math.max(320, targetW); targetH = Math.max(240, targetH);
  shot.width = targetW; shot.height = targetH;
  const ctx = shot.getContext('2d');
  ctx.drawImage(video, 0, 0, targetW, targetH);
  return shot.toDataURL('image/jpeg', 0.85);
}

async function startCamera(){
  try{
    codeReader = codeReader || new ZXing.BrowserMultiFormatReader();
    const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
    const deviceId = devices?.[0]?.deviceId || undefined;

    await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
      if (result) onBarcode(result.getText());
    });
    stopFn = async ()=>{ try{ await codeReader.reset(); }catch{} };
  }catch(e){ alert('Greška kamere: '+e.message); }
}
async function stopCamera(){ try{ if(stopFn) await stopFn(); }catch{} try{ if(codeReader) await codeReader.reset(); }catch{} stopFn=null; }

async function onBarcode(code){
  if (code === lastBarcode) return; // izbjegni dupli spam
  lastBarcode = code;
  barcodeEl.textContent = code;

  // Dohvati artikal po barkodu (preko backenda)
  try{
    const r = await fetch('/api/product/'+encodeURIComponent(code));
    const p = r.ok ? await r.json() : null;
    lastProduct = p?.name ? (p.name + (p.brand ? ` (${p.brand})` : '')) : 'Nepoznato';
    productEl.textContent = lastProduct;
  }catch{ lastProduct='Nepoznato'; productEl.textContent='Nepoznato'; }

  // Automatski snimi kadar i OCR + spremi
  await snapAndOCR(true);
}

async function snapAndOCR(auto=false){
  const dataURL = drawSnapshot(0.7);
  if (!dataURL){ expiryEl.textContent = 'Nije uspjelo snimanje'; return; }
  expiryEl.textContent = 'Čitam…'; confEl.textContent = '—';

  try{
    const r = await fetch('/api/ocr-date', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ imageData: dataURL }) });
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    let bestIso = null, bestRaw = null, score = 0;
    if (j?.best?.iso){ bestIso=j.best.iso; bestRaw=j.best.raw; score = j.best.score ?? 0; }
    expiryEl.innerHTML = bestIso ? `${bestIso} <span class="muted">(“${bestRaw}”)</span>` : 'Nije nađen jasan datum';
    confEl.textContent = score.toFixed(1);

    // Auto-spremi sken (bez slike radi veličine)
    await fetch('/api/scan/save', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        barcode: lastBarcode,
        product: lastProduct,
        expiry: bestIso,
        ocr_raw: bestRaw
        // imageData: dataURL, // uključi ako želiš spremati i sličicu
      })
    }).catch(()=>{});
  }catch(e){
    expiryEl.textContent = 'Greška: '+e.message;
    confEl.textContent = '—';
  }
}

// UI
document.getElementById('startBtn').addEventListener('click', startCamera);
document.getElementById('stopBtn').addEventListener('click', stopCamera);
document.getElementById('snapBtn').addEventListener('click', ()=>snapAndOCR(false));

// auto-start
startCamera();
</script>
</body>
</html>

